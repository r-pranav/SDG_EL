<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Live Air Quality Dashboard</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f7f9fc;
    color: #222;
    max-width: 600px;
    margin: 30px auto;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
  }
  h1 {
    text-align: center;
    color: #0275d8;
    margin-bottom: 30px;
  }
  .data-row {
    margin: 12px 0;
    font-size: 1.2em;
  }
  .label {
    font-weight: 700;
  }
  .value {
    margin-left: 8px;
    color: #444;
  }
  .aqi-good { color: green; }
  .aqi-moderate { color: orange; }
  .aqi-unhealthy { color: red; }
  .aqi-very-unhealthy { color: darkred; }
  hr {
    margin: 25px 0;
    border-color: #ccc;
  }
  footer {
    margin-top: 40px;
    text-align: center;
    font-size: 0.9em;
    color: #666;
  }
</style>
</head>
<body>

<h1>Live Air Quality Dashboard</h1>

<div id="data">
  <div class="data-row"><span class="label">CO₂ (ppm):</span><span id="co2" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">NH₃ (ppm):</span><span id="nh3" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">NOₓ (ppm):</span><span id="nox" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">CO (ppm):</span><span id="co" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">VOC (ppm):</span><span id="voc" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">Alcohol/Smoke (ppm):</span><span id="alcohol" class="value">Loading...</span></div>

  <hr />

  <div class="data-row"><span class="label">Oxygen (%):</span><span id="oxygen" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">Nitrogen (%):</span><span id="nitrogen" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">Carbon Dioxide (%):</span><span id="carbonDioxide" class="value">Loading...</span></div>
  <div class="data-row"><span class="label">Other gases (%):</span><span id="others" class="value">Loading...</span></div>

  <hr />

  <div class="data-row">
    <span class="label">Air Quality Index:</span>
    <span id="aqi" class="value">Loading...</span>
  </div>
</div>

<footer>Powered by Firebase & NodeMCU Sensor Data</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC634Ru39oQtt5IfewhKb8hpt7X0SieTUs",
    authDomain: "sdg-project-311ec.firebaseapp.com",
    databaseURL: "https://sdg-project-311ec-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sdg-project-311ec",
    storageBucket: "sdg-project-311ec.firebasestorage.app",
    messagingSenderId: "831077716",
    appId: "1:831077716:web:fd9dc93f10b7d84cce9cc1",
    measurementId: "G-VQMNNGGMX0"
  };

  firebase.initializeApp(firebaseConfig);

  const sensorRef = firebase.database().ref('/sensorData');

  sensorRef.on('value', snapshot => {
    const allData = snapshot.val();
    if (!allData) {
      console.warn("No data found");
      return;
    }

    // Convert data object to entries array and sort descending by key (latest first)
    const entries = Object.entries(allData);
    entries.sort((a, b) => (a[0] < b[0]) ? 1 : -1);

    // Get latest sensor data object
    const latestData = entries[0][1];
    console.log("Latest sensor data:", latestData);

    updateData(latestData);
  }, error => {
    console.error("Firebase read error:", error);
  });

  function updateData(data) {
    if (!data) return;

    document.getElementById('co2').textContent = data.ppm_CO2 ?? 'N/A';
    document.getElementById('nh3').textContent = data.ppm_NH3 ?? 'N/A';
    document.getElementById('nox').textContent = data.ppm_NOx ?? 'N/A';
    document.getElementById('co').textContent = data.ppm_CO ?? 'N/A';
    document.getElementById('voc').textContent = data.ppm_VOC ?? 'N/A';
    document.getElementById('alcohol').textContent = data.ppm_Alcohol ?? 'N/A';

    document.getElementById('oxygen').textContent = data.percentO2 ?? 'N/A';
    document.getElementById('nitrogen').textContent = data.percentN2 ?? 'N/A';
    document.getElementById('carbonDioxide').textContent = data.percentCO2 ?? 'N/A';
    document.getElementById('others').textContent = data.percentOthers ?? 'N/A';

    const aqi = data.AQI || data.Aqi || data.aqi || "N/A";
    const aqiElem = document.getElementById('aqi');
    aqiElem.textContent = aqi;

    aqiElem.className = "value ";
    switch (aqi.toLowerCase()) {
      case "good": aqiElem.classList.add("aqi-good"); break;
      case "moderate": aqiElem.classList.add("aqi-moderate"); break;
      case "unhealthy": aqiElem.classList.add("aqi-unhealthy"); break;
      case "very unhealthy": aqiElem.classList.add("aqi-very-unhealthy"); break;
    }
  }
</script>

</body>
</html>
