<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Air Quality Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

  <style>
    :root {
      --bg-light: #fefefe;
      --text-light: #111;
      --bg-dark: #111;
      --text-dark: #eee;
      --accent: #007aff;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      transition: background 0.3s ease, color 0.3s ease;
      padding: 20px;
    }

    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    h1 {
      text-align: center;
      font-weight: 600;
      color: var(--accent);
    }

    .toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      background: none;
      border: 2px solid var(--accent);
      border-radius: 20px;
      color: var(--accent);
      padding: 5px 15px;
      font-weight: 600;
      cursor: pointer;
    }

    .card {
      max-width: 900px;
      margin: 30px auto;
      padding: 20px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(5px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
    }

    .dark .card {
      background: rgba(30, 30, 30, 0.7);
    }

    canvas {
      width: 100% !important;
      height: 300px !important;
      margin-top: 30px;
    }

    .label-value {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 1.1em;
    }

    @media screen and (max-width: 600px) {
      .label-value {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

<button class="toggle" onclick="toggleDark()">Toggle Dark Mode</button>
<h1>Air Quality Dashboard</h1>

<div class="card" id="liveData">
  <h2>Live Sensor Readings</h2>
  <div id="liveValues"></div>
</div>

<div class="card">
  <h2>Historical Graphs</h2>
  <canvas id="chartCO2"></canvas>
  <canvas id="chartVOC"></canvas>
  <canvas id="chartO2"></canvas>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyC634Ru39oQtt5IfewhKb8hpt7X0SieTUs",
    authDomain: "sdg-project-311ec.firebaseapp.com",
    databaseURL: "https://sdg-project-311ec-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "sdg-project-311ec",
    storageBucket: "sdg-project-311ec.appspot.com",
    messagingSenderId: "831077716",
    appId: "1:831077716:web:fd9dc93f10b7d84cce9cc1"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database().ref("/sensorData");

  function updateLive(data) {
    const container = document.getElementById("liveValues");
    container.innerHTML = "";

    const fields = {
      ppm_CO2: "CO₂ (ppm)",
      ppm_NH3: "NH₃ (ppm)",
      ppm_NOx: "NOₓ (ppm)",
      ppm_CO: "CO (ppm)",
      ppm_VOC: "VOC (ppm)",
      ppm_Alcohol: "Alcohol (ppm)",
      percentO2: "O₂ (%)",
      percentN2: "N₂ (%)",
      percentCO2: "CO₂ (%)",
      percentOthers: "Other gases (%)",
      AQI: "AQI Category",
      timestamp: "Timestamp (IST)"
    };

    for (const key in fields) {
      const div = document.createElement("div");
      div.className = "label-value";
      div.innerHTML = `<span>${fields[key]}</span><span>${data[key] ?? 'N/A'}</span>`;
      container.appendChild(div);
    }
  }

  function toggleDark() {
    const isDark = document.body.classList.toggle("dark");
    const textColor = isDark ? '#eee' : '#111';
    const gridColor = isDark ? '#444' : '#ccc';

    Object.values(charts).forEach(chart => {
      chart.options.scales.x.ticks.color = textColor;
      chart.options.scales.y.ticks.color = textColor;
      chart.options.scales.x.grid.color = gridColor;
      chart.options.scales.y.grid.color = gridColor;
      chart.options.plugins.tooltip.titleColor = textColor;
      chart.options.plugins.tooltip.bodyColor = textColor;
      chart.update();
    });
  }

  const charts = {
    co2: new Chart(document.getElementById("chartCO2"), {
      type: 'line',
      data: { labels: [], datasets: [{ label: "CO₂ (ppm)", data: [], borderColor: "#e74c3c", fill: false }] },
      options: getChartOptions("CO₂ (ppm)")
    }),
    voc: new Chart(document.getElementById("chartVOC"), {
      type: 'line',
      data: { labels: [], datasets: [{ label: "VOC (ppm)", data: [], borderColor: "#8e44ad", fill: false }] },
      options: getChartOptions("VOC (ppm)")
    }),
    o2: new Chart(document.getElementById("chartO2"), {
      type: 'line',
      data: { labels: [], datasets: [{ label: "O₂ (%)", data: [], borderColor: "#3498db", fill: false }] },
      options: getChartOptions("O₂ (%)")
    })
  };

  function getChartOptions(yLabel) {
    return {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: {
          title: { display: true, text: "Time" },
          ticks: { color: '#111' },
          grid: { color: '#ccc' }
        },
        y: {
          title: { display: true, text: yLabel },
          ticks: { color: '#111' },
          grid: { color: '#ccc' }
        }
      },
      plugins: {
        tooltip: {
          backgroundColor: '#fff',
          titleColor: '#111',
          bodyColor: '#111'
        },
        zoom: {
          pan: {
            enabled: true,
            mode: 'xy'
          },
          zoom: {
            pinch: {
              enabled: true
            },
            wheel: {
              enabled: true
            },
            mode: 'xy'
          }
        }
      }
    };
  }

  db.limitToLast(50).on('value', snapshot => {
    const data = snapshot.val();
    if (!data) return;
    const sorted = Object.entries(data).sort((a, b) => a[0] > b[0] ? 1 : -1);
    const latest = sorted[sorted.length - 1][1];
    updateLive(latest);

    const labels = sorted.map(d => new Date(d[1].timestamp).toLocaleTimeString("en-IN"));
    charts.co2.data.labels = labels;
    charts.voc.data.labels = labels;
    charts.o2.data.labels = labels;

    charts.co2.data.datasets[0].data = sorted.map(d => d[1].ppm_CO2);
    charts.voc.data.datasets[0].data = sorted.map(d => d[1].ppm_VOC);
    charts.o2.data.datasets[0].data = sorted.map(d => d[1].percentO2);

    charts.co2.update();
    charts.voc.update();
    charts.o2.update();
  });
</script>
</body>
</html>
